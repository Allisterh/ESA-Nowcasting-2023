---
title: Production volume in industry challenge
---

The monthly PVI indicator represents the production index in industry.
The objective of the index is to measure changes in the volume of output at monthly intervals.
It provides a measure of the volume trend in value added over a given reference period.
The production index is calculated in the form of a Laspeyres type index.

## Forecast for a given country, with modular history

```{r}
#| cache: false

data <- targets::tar_read(data, store = "store_data")
targets::tar_load(predictions_pvi, store = "store_pvi")

sample <- data$PVI$data |>
  dplyr::filter((nace_r2 %in% "B-D"))

ojs_define(data = sample, pred = predictions_pvi)
```

```{ojs}
sample = format_historical_data(data, ctr_iso)
```

```{ojs}
preds = format_pred_data(pred, ctr_iso)
```

```{ojs}
viewof country = Inputs.select(ctry_challenge, {label: "Select a country:"})
```


```{ojs}
addTooltips(
Plot.plot({
  grid: true,
  y: {
    label: "Production volume in industry",
  },  
  x: {
      label: "Year",
      domain: range
    },
  marks: [
    Plot.line(sample, {
        x: "date", 
        y: "values", 
        stroke: "black",
        title: (d) =>
              `${d.date.toLocaleString("en-UK", {
                month: "long",
                year: "numeric"
              })}\n ${d.values} `
        }),
    Plot.dot(preds, {
        x: "date", 
        y: "values",
        fill: "model",
        title: (d) =>
              `${d.date.toLocaleString("en-UK", {
                month: "long",
                year: "numeric"
              })}\n ${d.values} `
        })
  ],
  color: {legend: true}
})
)
```

```{ojs}
dates = {
  const data = sample.map(d => d.date)
  data.push(preds.map(d => d.date)[0])
  return data  
}

viewof range = offsetInterval(dates, {
  value: [ dates[dates.length-90], dates[dates.length-1] ],
  format: ([a, b]) => htl.html`<span ${{
    style: "display: flex; justify-content: space-between"
  }}>
    ${a.toISOString("en-UK").slice(0, 10)}
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    ${b.toISOString("en-UK").slice(0, 10)}
  </span>`
})
```


<!-- HELPERS -->


```{ojs}
ctry_challenge = unique(transpose(pred).map(d => map_country_name[d.Country])).filter(value => value !== undefined)
```

```{ojs}
ctr_iso = Object.keys(map_country_name).find(key => map_country_name[key] === country);
```

<!-- DEPENDENCIES -->


```{ojs}
import { 
    map_country_name,
    unique,
    format_historical_data,
    format_pred_data,
     } from "./utils/utils.qmd"

```


```{ojs}
import {addTooltips} from "@mkfreeman/plot-tooltip"
import {offsetInterval} from '@mootari/offset-slider'
```
